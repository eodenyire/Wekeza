@page
@model Wekeza.MVP4._0.Pages.CustomerCare.InquiriesModel
@{
    ViewData["Title"] = "Customer Inquiries";
    ViewData["UserName"] = Model.UserName;
    ViewData["UserRole"] = "Customer Care Officer";
    ViewData["UserInitials"] = Model.UserInitials;
    ViewData["NotificationCount"] = Model.NotificationCount;
    Layout = "~/Pages/Shared/_DashboardLayout.cshtml";
}

@section SidebarMenu {
    <li class="sidebar-menu-item">
        <a href="/CustomerCare" class="sidebar-menu-link">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
    </li>
    <li class="sidebar-menu-item">
        <a href="/CustomerCare/Search" class="sidebar-menu-link">
            <i class="fas fa-search"></i>
            <span>Search Customer</span>
        </a>
    </li>
    <li class="sidebar-menu-item">
        <a href="/CustomerCare/Inquiries" class="sidebar-menu-link active">
            <i class="fas fa-question-circle"></i>
            <span>Inquiries</span>
        </a>
    </li>
    <li class="sidebar-menu-item">
        <a href="/CustomerCare/Complaints" class="sidebar-menu-link">
            <i class="fas fa-comment-dots"></i>
            <span>Complaints</span>
        </a>
    </li>
    <li class="sidebar-menu-item">
        <a href="/CustomerCare/Feedback" class="sidebar-menu-link">
            <i class="fas fa-star"></i>
            <span>Feedback</span>
        </a>
    </li>
}

<div class="page-header">
    <h3>Customer Inquiries</h3>
    <p>Manage customer inquiries and information requests</p>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="search-filters">
            <div class="row">
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="Open">Open</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="categoryFilter">
                        <option value="">All Categories</option>
                        <option value="Account Balance">Account Balance</option>
                        <option value="Transaction Query">Transaction Query</option>
                        <option value="Statement Request">Statement Request</option>
                        <option value="Card Information">Card Information</option>
                        <option value="General Inquiry">General Inquiry</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control" id="searchInquiry" placeholder="Search inquiries...">
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-primary" onclick="createInquiry()">
            <i class="fas fa-plus"></i> New Inquiry
        </button>
        <button class="btn btn-outline-secondary" onclick="refreshInquiries()">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>
</div>

<div class="data-table">
    <table class="table" id="inquiriesTable">
        <thead>
            <tr>
                <th>Inquiry #</th>
                <th>Customer</th>
                <th>Subject</th>
                <th>Category</th>
                <th>Status</th>
                <th>Created</th>
                <th>Response Time</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="inquiriesTableBody">
            <tr>
                <td colspan="8" class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Create Inquiry Modal -->
<div class="modal fade" id="createInquiryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Inquiry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createInquiryForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Customer ID</label>
                                <input type="text" class="form-control" id="customerId" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="category" required>
                                    <option value="">Select Category</option>
                                    <option value="Account Balance">Account Balance</option>
                                    <option value="Transaction Query">Transaction Query</option>
                                    <option value="Statement Request">Statement Request</option>
                                    <option value="Card Information">Card Information</option>
                                    <option value="General Inquiry">General Inquiry</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subject</label>
                        <input type="text" class="form-control" id="subject" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="4" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitInquiry()">Create Inquiry</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
let authToken = '';

$(document).ready(function() {
    authToken = getCookie('authToken') || sessionStorage.getItem('authToken') || '';
    loadInquiries();
    
    $('#statusFilter, #categoryFilter').change(function() {
        loadInquiries();
    });
    
    $('#searchInquiry').on('input', debounce(function() {
        loadInquiries();
    }, 300));
});

function loadInquiries() {
    // For now, load complaints with inquiry-type categories
    const status = $('#statusFilter').val();
    const category = $('#categoryFilter').val();
    
    let url = '/api/customercare/complaints';
    const params = new URLSearchParams();
    if (status) params.append('status', status);
    
    if (params.toString()) {
        url += '?' + params.toString();
    }
    
    $.ajax({
        url: url,
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + authToken,
            'Content-Type': 'application/json'
        },
        success: function(response) {
            if (response.success) {
                // Filter for inquiry-type complaints
                const inquiries = response.data.filter(item => 
                    ['Account Balance', 'Transaction Query', 'Statement Request', 'Card Information', 'General Inquiry', 'Inquiry'].includes(item.category)
                );
                displayInquiries(inquiries);
            } else {
                showAlert('Error loading inquiries: ' + response.message, 'danger');
            }
        },
        error: function(xhr) {
            console.error('Error loading inquiries:', xhr);
            showAlert('Error loading inquiries. Please try again.', 'danger');
        }
    });
}

function displayInquiries(inquiries) {
    const tbody = $('#inquiriesTableBody');
    tbody.empty();
    
    if (inquiries.length === 0) {
        tbody.append('<tr><td colspan="8" class="text-center">No inquiries found</td></tr>');
        return;
    }
    
    inquiries.forEach(inquiry => {
        const statusBadge = getStatusBadge(inquiry.status);
        const createdDate = new Date(inquiry.createdAt).toLocaleDateString();
        const responseTime = calculateResponseTime(inquiry.createdAt, inquiry.resolvedAt);
        
        const row = `
            <tr>
                <td>${inquiry.complaintNumber}</td>
                <td>${inquiry.customer ? inquiry.customer.fullName : 'N/A'}</td>
                <td>${inquiry.subject}</td>
                <td>${inquiry.category}</td>
                <td>${statusBadge}</td>
                <td>${createdDate}</td>
                <td>${responseTime}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewInquiry('${inquiry.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="resolveInquiry('${inquiry.id}')">
                        <i class="fas fa-check"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

function calculateResponseTime(createdAt, resolvedAt) {
    if (!resolvedAt) return 'Pending';
    
    const created = new Date(createdAt);
    const resolved = new Date(resolvedAt);
    const diffHours = Math.round((resolved - created) / (1000 * 60 * 60));
    
    if (diffHours < 24) return `${diffHours}h`;
    return `${Math.round(diffHours / 24)}d`;
}

function getStatusBadge(status) {
    const badges = {
        'Open': 'bg-warning',
        'In Progress': 'bg-info',
        'Resolved': 'bg-success',
        'Closed': 'bg-secondary'
    };
    return `<span class="badge ${badges[status] || 'bg-secondary'}">${status}</span>`;
}

function createInquiry() {
    $('#createInquiryModal').modal('show');
}

function submitInquiry() {
    const formData = {
        customerId: $('#customerId').val(),
        subject: $('#subject').val(),
        description: $('#description').val(),
        category: $('#category').val(),
        priority: 'Medium' // Default for inquiries
    };
    
    $.ajax({
        url: '/api/customercare/complaints',
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + authToken,
            'Content-Type': 'application/json'
        },
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.success) {
                $('#createInquiryModal').modal('hide');
                $('#createInquiryForm')[0].reset();
                showAlert('Inquiry created successfully', 'success');
                loadInquiries();
            } else {
                showAlert('Error creating inquiry: ' + response.message, 'danger');
            }
        },
        error: function(xhr) {
            console.error('Error creating inquiry:', xhr);
            showAlert('Error creating inquiry. Please try again.', 'danger');
        }
    });
}

function viewInquiry(inquiryId) {
    window.location.href = `/CustomerCare/Complaints?id=${inquiryId}`;
}

function resolveInquiry(inquiryId) {
    $.ajax({
        url: `/api/customercare/complaints/${inquiryId}/updates`,
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + authToken,
            'Content-Type': 'application/json'
        },
        data: JSON.stringify({
            updateText: 'Inquiry resolved - Information provided to customer'
        }),
        success: function(response) {
            if (response.success) {
                showAlert('Inquiry resolved successfully', 'success');
                loadInquiries();
            } else {
                showAlert('Error resolving inquiry: ' + response.message, 'danger');
            }
        },
        error: function(xhr) {
            console.error('Error resolving inquiry:', xhr);
            showAlert('Error resolving inquiry. Please try again.', 'danger');
        }
    });
}

function refreshInquiries() {
    loadInquiries();
    showAlert('Inquiries refreshed', 'info');
}

// Utility functions
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('.page-header').after(alertHtml);
    
    setTimeout(() => {
        $('.alert').fadeOut();
    }, 5000);
}
</script>
}