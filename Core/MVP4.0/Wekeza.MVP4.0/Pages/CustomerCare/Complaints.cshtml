@page
@model Wekeza.MVP4._0.Pages.CustomerCare.ComplaintsModel
@{
    ViewData["Title"] = "Customer Complaints";
    ViewData["UserName"] = Model.UserName;
    ViewData["UserRole"] = "Customer Care Officer";
    ViewData["UserInitials"] = Model.UserInitials;
    ViewData["NotificationCount"] = Model.NotificationCount;
    Layout = "~/Pages/Shared/_DashboardLayout.cshtml";
}

@section SidebarMenu {
    <li class="sidebar-menu-item">
        <a href="/CustomerCare" class="sidebar-menu-link">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
    </li>
    <li class="sidebar-menu-item">
        <a href="/CustomerCare/Search" class="sidebar-menu-link">
            <i class="fas fa-search"></i>
            <span>Search Customer</span>
        </a>
    </li>
    <li class="sidebar-menu-item">
        <a href="/CustomerCare/Inquiries" class="sidebar-menu-link">
            <i class="fas fa-question-circle"></i>
            <span>Inquiries</span>
        </a>
    </li>
    <li class="sidebar-menu-item">
        <a href="/CustomerCare/Complaints" class="sidebar-menu-link active">
            <i class="fas fa-comment-dots"></i>
            <span>Complaints</span>
        </a>
    </li>
    <li class="sidebar-menu-item">
        <a href="/CustomerCare/Accounts" class="sidebar-menu-link">
            <i class="fas fa-wallet"></i>
            <span>Account Services</span>
        </a>
    </li>
    <li class="sidebar-menu-item">
        <a href="/CustomerCare/Reports" class="sidebar-menu-link">
            <i class="fas fa-chart-bar"></i>
            <span>Reports</span>
        </a>
    </li>
    <li class="sidebar-menu-item">
        <a href="/CustomerCare/Feedback" class="sidebar-menu-link">
            <i class="fas fa-star"></i>
            <span>Feedback</span>
        </a>
    </li>
}

<div class="page-header">
    <h3>Customer Complaints Management</h3>
    <p>Handle and track customer complaints and issues</p>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="search-filters">
            <div class="row">
                <div class="col-md-4">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="Open">Open</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select" id="priorityFilter">
                        <option value="">All Priority</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control" id="searchComplaint" placeholder="Search complaints...">
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-primary" onclick="createComplaint()">
            <i class="fas fa-plus"></i> New Complaint
        </button>
        <button class="btn btn-outline-secondary" onclick="refreshComplaints()">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>
</div>

<div class="data-table">
    <table class="table" id="complaintsTable">
        <thead>
            <tr>
                <th>Complaint #</th>
                <th>Customer</th>
                <th>Subject</th>
                <th>Category</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="complaintsTableBody">
            <tr>
                <td colspan="8" class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Create Complaint Modal -->
<div class="modal fade" id="createComplaintModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Complaint</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createComplaintForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Customer ID</label>
                                <input type="text" class="form-control" id="customerId" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="category" required>
                                    <option value="">Select Category</option>
                                    <option value="Account Issue">Account Issue</option>
                                    <option value="Transaction Problem">Transaction Problem</option>
                                    <option value="Card Issue">Card Issue</option>
                                    <option value="Service Quality">Service Quality</option>
                                    <option value="System Error">System Error</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Priority</label>
                                <select class="form-select" id="priority" required>
                                    <option value="Low">Low</option>
                                    <option value="Medium" selected>Medium</option>
                                    <option value="High">High</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Subject</label>
                                <input type="text" class="form-control" id="subject" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="4" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitComplaint()">Create Complaint</button>
            </div>
        </div>
    </div>
</div>

<!-- View Complaint Modal -->
<div class="modal fade" id="viewComplaintModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Complaint Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="complaintDetails">
                <!-- Complaint details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="updateComplaint()">Add Update</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
let authToken = '';

$(document).ready(function() {
    // Get auth token from cookie or session
    authToken = getCookie('authToken') || sessionStorage.getItem('authToken') || '';
    loadComplaints();
    
    // Set up filters
    $('#statusFilter, #priorityFilter').change(function() {
        loadComplaints();
    });
    
    $('#searchComplaint').on('input', debounce(function() {
        loadComplaints();
    }, 300));
});

function loadComplaints() {
    const status = $('#statusFilter').val();
    const priority = $('#priorityFilter').val();
    const search = $('#searchComplaint').val();
    
    let url = '/api/customercare/complaints';
    const params = new URLSearchParams();
    if (status) params.append('status', status);
    if (priority) params.append('priority', priority);
    if (search) params.append('search', search);
    
    if (params.toString()) {
        url += '?' + params.toString();
    }
    
    $.ajax({
        url: url,
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + authToken,
            'Content-Type': 'application/json'
        },
        success: function(response) {
            if (response.success) {
                displayComplaints(response.data);
            } else {
                showAlert('Error loading complaints: ' + response.message, 'danger');
            }
        },
        error: function(xhr) {
            console.error('Error loading complaints:', xhr);
            showAlert('Error loading complaints. Please try again.', 'danger');
        }
    });
}

function displayComplaints(complaints) {
    const tbody = $('#complaintsTableBody');
    tbody.empty();
    
    if (complaints.length === 0) {
        tbody.append('<tr><td colspan="8" class="text-center">No complaints found</td></tr>');
        return;
    }
    
    complaints.forEach(complaint => {
        const statusBadge = getStatusBadge(complaint.status);
        const priorityBadge = getPriorityBadge(complaint.priority);
        const createdDate = new Date(complaint.createdAt).toLocaleDateString();
        
        const row = `
            <tr>
                <td>${complaint.complaintNumber}</td>
                <td>${complaint.customer ? complaint.customer.fullName : 'N/A'}</td>
                <td>${complaint.subject}</td>
                <td>${complaint.category}</td>
                <td>${priorityBadge}</td>
                <td>${statusBadge}</td>
                <td>${createdDate}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewComplaint('${complaint.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="updateComplaintStatus('${complaint.id}', 'Resolved')">
                        <i class="fas fa-check"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

function getStatusBadge(status) {
    const badges = {
        'Open': 'bg-warning',
        'In Progress': 'bg-info',
        'Resolved': 'bg-success',
        'Closed': 'bg-secondary'
    };
    return `<span class="badge ${badges[status] || 'bg-secondary'}">${status}</span>`;
}

function getPriorityBadge(priority) {
    const badges = {
        'High': 'bg-danger',
        'Medium': 'bg-warning',
        'Low': 'bg-info'
    };
    return `<span class="badge ${badges[priority] || 'bg-secondary'}">${priority}</span>`;
}

function createComplaint() {
    $('#createComplaintModal').modal('show');
}

function submitComplaint() {
    const formData = {
        customerId: $('#customerId').val(),
        subject: $('#subject').val(),
        description: $('#description').val(),
        category: $('#category').val(),
        priority: $('#priority').val()
    };
    
    $.ajax({
        url: '/api/customercare/complaints',
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + authToken,
            'Content-Type': 'application/json'
        },
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.success) {
                $('#createComplaintModal').modal('hide');
                $('#createComplaintForm')[0].reset();
                showAlert('Complaint created successfully', 'success');
                loadComplaints();
            } else {
                showAlert('Error creating complaint: ' + response.message, 'danger');
            }
        },
        error: function(xhr) {
            console.error('Error creating complaint:', xhr);
            showAlert('Error creating complaint. Please try again.', 'danger');
        }
    });
}

function viewComplaint(complaintId) {
    $.ajax({
        url: `/api/customercare/complaints/${complaintId}`,
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + authToken,
            'Content-Type': 'application/json'
        },
        success: function(response) {
            if (response.success) {
                displayComplaintDetails(response.data);
                $('#viewComplaintModal').modal('show');
            } else {
                showAlert('Error loading complaint details: ' + response.message, 'danger');
            }
        },
        error: function(xhr) {
            console.error('Error loading complaint details:', xhr);
            showAlert('Error loading complaint details. Please try again.', 'danger');
        }
    });
}

function displayComplaintDetails(complaint) {
    const details = `
        <div class="row">
            <div class="col-md-6">
                <strong>Complaint #:</strong> ${complaint.complaintNumber}<br>
                <strong>Customer:</strong> ${complaint.customer ? complaint.customer.fullName : 'N/A'}<br>
                <strong>Category:</strong> ${complaint.category}<br>
                <strong>Priority:</strong> ${complaint.priority}
            </div>
            <div class="col-md-6">
                <strong>Status:</strong> ${complaint.status}<br>
                <strong>Created:</strong> ${new Date(complaint.createdAt).toLocaleString()}<br>
                <strong>Created By:</strong> ${complaint.createdBy}<br>
                <strong>Assigned To:</strong> ${complaint.assignedTo || 'Unassigned'}
            </div>
        </div>
        <hr>
        <div class="mb-3">
            <strong>Subject:</strong> ${complaint.subject}
        </div>
        <div class="mb-3">
            <strong>Description:</strong><br>
            ${complaint.description}
        </div>
        ${complaint.updates && complaint.updates.length > 0 ? `
        <div class="mb-3">
            <strong>Updates:</strong>
            <div class="mt-2">
                ${complaint.updates.map(update => `
                    <div class="border-start border-3 border-info ps-3 mb-2">
                        <small class="text-muted">${new Date(update.createdAt).toLocaleString()} - ${update.createdBy}</small><br>
                        ${update.updateText}
                    </div>
                `).join('')}
            </div>
        </div>
        ` : ''}
    `;
    $('#complaintDetails').html(details);
}

function refreshComplaints() {
    loadComplaints();
    showAlert('Complaints refreshed', 'info');
}

function updateComplaintStatus(complaintId, status) {
    $.ajax({
        url: `/api/customercare/complaints/${complaintId}/updates`,
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + authToken,
            'Content-Type': 'application/json'
        },
        data: JSON.stringify({
            updateText: `Status changed to ${status}`,
            status: status
        }),
        success: function(response) {
            if (response.success) {
                showAlert(`Complaint status updated to ${status}`, 'success');
                loadComplaints();
            } else {
                showAlert('Error updating complaint: ' + response.message, 'danger');
            }
        },
        error: function(xhr) {
            console.error('Error updating complaint:', xhr);
            showAlert('Error updating complaint. Please try again.', 'danger');
        }
    });
}

// Utility functions
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('.page-header').after(alertHtml);
    
    setTimeout(() => {
        $('.alert').fadeOut();
    }, 5000);
}
</script>
}